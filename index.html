<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPTDB Photo Stream</title>
    <script src="https://cdn.jsdelivr.net/npm/epoxy-tls-polyfill@1/dist/javascript.min.js"></script>
    <style>
        * {
            touch-action: manipulation;
            margin: 0px;
            padding: 0px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            font-weight: normal;
            border: none;
            --pc: calc(min(100vw, calc(100dvh / 16 * 9)) / 100);
            --spacing: 3;
        }
        img.streamImage {
            display: block;
            height: auto;
        }
        img.ipsUserPhoto {
            width: calc(15 * var(--pc));
            aspect-ratio: 1 / 1;
            object-fit: cover;
            margin-right: calc(3 * var(--pc));
            border-radius: calc(3 * var(--pc));
        }
        h1, h2 {
            font-size: calc(5 * var(--pc));
            font-weight: bold;
            font-family: Arial, sans-serif;
            overflow-wrap: break-word;
            min-width: 0;
        }
        #heading-container {
            display: flex;
            align-items: center;
        }
        #app {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: calc(var(--spacing) / 2 * var(--pc));
            width: calc(95 * var(--pc));
            overflow-y: auto;
            background-color: #eae5e4;
        }
        #app > * {
            width: calc(100% - var(--spacing) * var(--pc));
            margin: calc(var(--spacing) / 2 * var(--pc));
        }
        body {
            display: flex;
            justify-content: center;
            height: 100dvh;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="heading-container">
            <img class="ipsUserPhoto">
            <h1 id="heading"></h1>
        </div>
    </div>
    <script>
    (async () => {
        const userId = window.location.hash.substring(2); // Remove "#/"
        if (!userId) {
            alert("No user ID provided in the URL hash.");
            return;
        }
        let page = 1, pageFetchEnabled = false;
        // let lastPost = {};

        const app = document.getElementById("app");

        async function fetchContent() {
            var content;
            try {
                const contentPage = await fetch(`https://cptdb.ca/profile/${userId}/content/page/${page}`);
                content = new DOMParser().parseFromString(await contentPage.text(), "text/html");
            } catch (e) {
                console.error("Failed to fetch content:", e);
                fetchContent(); // Retry fetching content
                return;
            }
            console.log("Fetched page", page);

            const userPhotoUrl = content.querySelector('#elProfilePhoto a[href^="https://cptdb.ca/uploads/monthly_"]').href;
            const userContent = content.getElementById("elUserContent");
            const userName = content.getElementsByTagName("h1")[0].textContent.trim();

            document.querySelector(".ipsUserPhoto").src = userPhotoUrl;
            document.getElementById("heading").textContent = userName + "'s Photo Stream";

            userContent.querySelectorAll("li.ipsStreamItem_contentBlock").forEach((post) => {
                const photoList = post.querySelectorAll('a[href^="https://cptdb.ca/uploads/monthly_"]:has(img[src^="https://cptdb.ca/uploads/monthly_"])');
                if (photoList.length === 0) {
                    return;
                }

                const postTime = document.createElement("h2");
                postTime.textContent = post.querySelector("ul.ipsStreamItem_meta time").dateTime;
                app.appendChild(postTime);

                photoList.forEach((el) => {
                    const img = document.createElement("img");
                    img.className = "streamImage";
                    img.src = el.href;
                    app.appendChild(img);
                });
            });

            if (content.querySelector("li.ipsPagination_next:not(.ipsPagination_inactive) a")) {
                pageFetchEnabled = true;
                page++;
            }
        }
        
        app.addEventListener("scroll", () => {
            if (pageFetchEnabled && app.scrollTop + app.clientHeight >= app.scrollHeight - app.clientHeight) {
                pageFetchEnabled = false;
                fetchContent();
            }
        });
        fetchContent();
    })();
    </script>
</body>
</html>