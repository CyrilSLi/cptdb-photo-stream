<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPTDB Photo Stream</title>
    <script src="https://cdn.jsdelivr.net/npm/epoxy-tls-polyfill@1/dist/javascript.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <div id="heading-container">
            <img class="ipsUserPhoto">
            <h1><a id="userLink" target="_blank">N/A</a>'s Photo Stream</h1>
        </div>
    </div>
    <script>
    (async () => {
        const params = new URLSearchParams(window.location.search);
        const userId = params.get("userId");
        if (!userId) {
            alert("Error: No user ID provided.");
            return;
        }
        let page = 1, pageFetchEnabled = false;

        const app = document.getElementById("app");
        const dateOptions = { year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false };

        async function fetchContent() {
            var content;
            const photoUrls = new Set();

            const loadingText = document.createElement("h2");
            loadingText.textContent = "Loading page " + page + "...";
            app.appendChild(loadingText);

            try {
                const contentPage = await fetch(`https://cptdb.ca/profile/${userId}/content/page/${page}`);
                content = new DOMParser().parseFromString(await contentPage.text(), "text/html");
            } catch (e) {
                console.error("Failed to fetch content:", e);
                fetchContent(); // Retry fetching content
                return;
            }
            console.log("Fetched page", page);

            const userPhotoUrl = (
                content.querySelector('#elProfilePhoto a[href^="https://cptdb.ca/uploads/monthly_"]')?.href ||
                content.querySelector("#elProfilePhoto img")?.src ||
                "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" // small fallback image
            );

            const userContent = content.getElementById("elUserContent");
            const userName = content.getElementsByTagName("h1")[0].textContent.trim();

            document.querySelector(".ipsUserPhoto").src = userPhotoUrl;
            document.getElementById("userLink").textContent = userName;
            document.getElementById("userLink").href = "https://cptdb.ca/profile/" + userId;
            app.removeChild(app.lastChild); // Remove loading text

            userContent.querySelectorAll("li.ipsStreamItem_contentBlock").forEach((post) => {
                const photoList = [...post.querySelectorAll('a[href^="https://cptdb.ca/uploads/monthly_"]:has(img[src^="https://cptdb.ca/uploads/monthly_"])')].filter((el) => {
                    if (photoUrls.has(el.href)) {
                        return false;
                    }
                    photoUrls.add(el.href);
                    return true;
                })
                if (photoList.length === 0) {
                    return;
                }

                const postLinkEl = post.querySelector("h2.ipsStreamItem_title a");
                var postText = post.querySelector("div.ipsType_richText > div")?.textContent.trim() || "";
                postText = postText.split(/\r?\n|\r/).reduce((acc, line) => { // Remove empty lines and trim whitespace from each line
                    if (line.trim() !== "") {
                        acc.push(line.trim());
                    }
                    return acc;
                }, []).join("</p><p>");

                const postDetails = document.createElement("div");
                postDetails.className = "postDetails";
                postDetails.innerHTML = `
                    <h2>${new Date(post.querySelector("ul.ipsStreamItem_meta time").dateTime).toLocaleString("en-US", dateOptions)}</h2>
                    <details>
                        <summary><h3><a href=${postLinkEl.href} target="_blank">${postLinkEl.textContent.trim()}</a></h3></summary>
                        <p>${postText}</p>
                    </details>
                `;
                app.appendChild(postDetails);

                photoList.forEach((el) => {
                    const img = document.createElement("img");
                    img.className = "streamImage";
                    img.src = el.href;
                    app.appendChild(img);
                });
            });

            if (content.querySelector("li.ipsPagination_next:not(.ipsPagination_inactive) a")) {
                page++;
                if (app.scrollTop + app.clientHeight >= app.scrollHeight - app.clientHeight) {
                    fetchContent(); // Fetched page could be short, fetch again if the newly loaded content doesn't fill the screen
                } else {
                    pageFetchEnabled = true;
                }
            } else {
                const lastPageText = document.createElement("h2");
                lastPageText.textContent = "End of Photo Stream";
                app.appendChild(lastPageText);
            }
        }
        
        app.addEventListener("scroll", () => {
            if (pageFetchEnabled && app.scrollTop + app.clientHeight >= app.scrollHeight - app.clientHeight) {
                pageFetchEnabled = false;
                fetchContent();
            }
        });
        fetchContent();
    })();
    </script>
</body>
</html>